jobs:
  update-tag:
     docker:
      - image: mesosphere/aws-cli
     steps:
      - checkout
      - run: pwd && cd containers && echo $CIRCLE_SHA1 && sed -i -e "s/latest/${CIRCLE_SHA1}/g" fargate.json && aws ecs register-task-definition --cli-input-json file:///root/project/containers/fargate.json
      - run: aws ecs create-service --cluster default --service-name nginx --task-definition sample-fargate:1 --launch-type "FARGATE"  --network-configuration "awsvpcConfiguration={subnets=[subnet-0f326b3a78edeb6f4],securityGroups=[sg-087086bd834b7fde6],assignPublicIp=ENABLED}" --cli-input-json file:///root/project/containers/fargate-service.json
      - run:
          command: |
            aws ecs list-services --cluster default && aws ecs list-task-definitions && aws ecs describe-services --cluster default --services nginx
version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@3.1.0
  aws-cli: circleci/aws-cli@0.1.4
  aws-ecs: circleci/aws-ecs@0.0.15   
workflows:
  build-and-deploy:
    jobs:
      - aws-ecr/build_and_push_image:
          name: build-and-push-nginx-image
          account-url: 'AWS_ECR_URL'
          repo: 'nginx'
          dockerfile: ~/project/containers/nginx/Dockerfile
          path: ~/project/containers/nginx
          region: 'AWS_DEFAULT_REGION'
          tag: '${CIRCLE_SHA1}'
      - update-tag:
          requires:
            - build-and-push-nginx-image
 
